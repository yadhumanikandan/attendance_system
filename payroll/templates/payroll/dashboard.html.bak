{% extends 'attendance/base.html' %}
{% load static %}

{% block title %}Payroll - {{ month_name }} {{ selected_year }}{% endblock %}

{% block extra_css %}
<style>
    :root {
        --bg-primary: #f8fafc;
        --bg-secondary: #ffffff;
        --bg-tertiary: #f1f5f9;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --text-muted: #94a3b8;
        --border-color: #e2e8f0;
        --primary-color: #3b82f6;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
    }

    .payroll-container {
        padding: 20px;
        max-width: 1600px;
        margin: 0 auto;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .page-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .month-selector {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .month-selector select {
        padding: 10px 16px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.875rem;
        background: var(--bg-secondary);
    }

    .btn-go {
        padding: 10px 20px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
    }

    .payroll-section {
        background: var(--bg-secondary);
        border-radius: 12px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .section-header {
        padding: 16px 20px;
        background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .section-header.sales {
        background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
    }

    .section-total {
        font-size: 1.5rem;
        font-weight: 700;
    }

    .payroll-table {
        width: 100%;
        border-collapse: collapse;
    }

    .payroll-table th {
        padding: 14px 12px;
        text-align: left;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-secondary);
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-color);
    }

    .payroll-table th.text-right,
    .payroll-table td.text-right {
        text-align: right;
    }

    .payroll-table td {
        padding: 12px;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.85rem;
    }

    .payroll-table tbody tr {
        cursor: pointer;
        transition: background 0.2s;
    }

    .payroll-table tbody tr:hover {
        background: #e0f2fe;
    }

    .employee-name {
        font-weight: 600;
        color: var(--text-primary);
    }

    .salary-amount {
        font-family: 'SF Mono', 'Monaco', monospace;
        color: var(--text-primary);
    }

    .base-payroll {
        font-family: 'SF Mono', 'Monaco', monospace;
        color: var(--text-secondary);
    }

    .incentive-amount {
        font-family: 'SF Mono', 'Monaco', monospace;
        color: var(--success-color);
        font-weight: 600;
    }

    .reduction-amount {
        font-family: 'SF Mono', 'Monaco', monospace;
        color: var(--danger-color);
        font-weight: 600;
    }

    .net-payroll {
        font-family: 'SF Mono', 'Monaco', monospace;
        font-weight: 700;
        color: var(--primary-color);
        font-size: 1rem;
    }

    .days-breakdown {
        font-size: 0.7rem;
        color: var(--text-muted);
    }

    .payroll-table tfoot td {
        font-weight: 700;
        background: var(--bg-tertiary);
        border-top: 2px solid var(--border-color);
    }

    .empty-state,
    .coming-soon {
        padding: 40px 20px;
        text-align: center;
        color: var(--text-muted);
    }

    .coming-soon-icon {
        font-size: 3rem;
        margin-bottom: 16px;
    }

    /* Adjustment Modal */
    .adjustment-modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(4px);
    }

    .adjustment-modal-overlay.show {
        display: flex;
    }

    .adjustment-modal {
        background: white;
        border-radius: 16px;
        width: 90%;
        max-width: 600px;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
    }

    .adjustment-modal-header {
        padding: 20px 24px;
        background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .adjustment-modal-header h3 {
        margin: 0;
        font-size: 1.25rem;
    }

    .modal-close-btn {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        opacity: 0.8;
    }

    .modal-close-btn:hover {
        opacity: 1;
        background: none;
    }

    .adjustment-modal-body {
        padding: 24px;
    }

    .existing-adjustments {
        margin-bottom: 24px;
    }

    .existing-adjustments h4 {
        margin: 0 0 12px 0;
        font-size: 0.875rem;
        color: var(--text-secondary);
        text-transform: uppercase;
    }

    .adjustment-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: var(--bg-tertiary);
        border-radius: 8px;
        margin-bottom: 8px;
    }

    .adjustment-info {
        flex: 1;
    }

    .adjustment-type-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        margin-right: 8px;
    }

    .adjustment-type-badge.incentive {
        background: #dcfce7;
        color: #166534;
    }

    .adjustment-type-badge.reduction {
        background: #fee2e2;
        color: #991b1b;
    }

    .adjustment-reason {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-top: 4px;
    }

    .delete-adjustment-btn {
        padding: 6px 12px;
        background: #fee2e2;
        color: #dc2626;
        border: none;
        border-radius: 6px;
        font-size: 0.75rem;
        cursor: pointer;
    }

    .delete-adjustment-btn:hover {
        background: #fecaca;
    }

    .no-adjustments {
        padding: 20px;
        text-align: center;
        color: var(--text-muted);
        font-size: 0.875rem;
    }

    .add-adjustment-form h4 {
        margin: 0 0 16px 0;
        font-size: 0.875rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        padding-top: 16px;
        border-top: 1px solid var(--border-color);
    }

    .form-row {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
    }

    .form-group {
        flex: 1;
    }

    .form-group label {
        display: block;
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-bottom: 6px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.875rem;
        box-sizing: border-box;
    }

    .form-group textarea {
        resize: vertical;
        min-height: 60px;
    }

    .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 20px;
    }

    .btn-cancel {
        padding: 10px 20px;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
    }

    .btn-save {
        padding: 10px 20px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
    }

    .click-hint {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-align: center;
        padding: 8px;
        background: #fef9c3;
        border-radius: 0 0 8px 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="payroll-container">
    <div class="page-header">
        <h1 class="page-title">
            üí∞ Payroll Calculator
        </h1>

        <form class="month-selector" method="GET">
            <select name="month">
                {% for m_val, m_name in months %}
                <option value="{{ m_val }}" {% if m_val==selected_month %}selected{% endif %}>{{ m_name }}</option>
                {% endfor %}
            </select>
            <select name="year">
                {% for y in years %}
                <option value="{{ y }}" {% if y==selected_year %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="btn-go">Calculate</button>
        </form>
    </div>

    <!-- Admin Section -->
    <div class="payroll-section">
        <div class="section-header">
            <span class="section-title">üëî Admin Department Payroll</span>
            <span class="section-total">AED {{ total_admin_payroll|floatformat:2 }}</span>
        </div>

        {% if admin_payroll_data %}
        <table class="payroll-table">
            <thead>
                <tr>
                    <th>Employee</th>
                    <th class="text-right">Salary</th>
                    <th class="text-right">Working Days</th>
                    <th class="text-right">Base Payroll</th>
                    <th class="text-right">Incentives</th>
                    <th class="text-right">Reductions</th>
                    <th class="text-right">Net Payroll</th>
                </tr>
            </thead>
            <tbody>
                {% for item in admin_payroll_data %}
                <tr onclick="openAdjustmentModal({{ item.employee.id }}, '{{ item.employee.name }}')">
                    <td class="employee-name">{{ item.employee.name }}</td>
                    <td class="text-right salary-amount">{{ item.salary|floatformat:0 }}</td>
                    <td class="text-right">
                        {{ item.working_days|floatformat:1 }}
                        <div class="days-breakdown">{{ item.full_days }}+{{ item.half_days }}√ó¬Ω+{{ item.holidays }}h
                        </div>
                    </td>
                    <td class="text-right base-payroll">{{ item.base_payroll|floatformat:2 }}</td>
                    <td class="text-right incentive-amount">{% if item.incentives > 0 %}+{{
                        item.incentives|floatformat:2 }}{% else %}-{% endif %}</td>
                    <td class="text-right reduction-amount">{% if item.reductions > 0 %}-{{
                        item.reductions|floatformat:2 }}{% else %}-{% endif %}</td>
                    <td class="text-right net-payroll">AED {{ item.net_payroll|floatformat:2 }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="3" class="text-right">Totals</td>
                    <td class="text-right">-</td>
                    <td class="text-right incentive-amount">+{{ total_incentives|floatformat:2 }}</td>
                    <td class="text-right reduction-amount">-{{ total_reductions|floatformat:2 }}</td>
                    <td class="text-right net-payroll">AED {{ total_admin_payroll|floatformat:2 }}</td>
                </tr>
            </tfoot>
        </table>
        <div class="click-hint">üí° Click on any row to add incentives or reductions</div>
        {% else %}
        <div class="empty-state">
            <p>No Admin employees found or no attendance data for {{ month_name }} {{ selected_year }}.</p>
            <p>Make sure employees have department set to "Admin" and salary is configured.</p>
        </div>
        {% endif %}
    </div>

    <!-- Sales Section (Coming Soon) -->
    <div class="payroll-section">
        <div class="section-header sales">
            <span class="section-title">üíº Sales Department Payroll</span>
            <span class="section-total">Coming Soon</span>
        </div>
        <div class="coming-soon">
            <div class="coming-soon-icon">üöß</div>
            <p>Sales payroll calculation will be implemented soon.</p>
        </div>
    </div>
</div>

<!-- Adjustment Modal -->
<div class="adjustment-modal-overlay" id="adjustmentModal">
    <div class="adjustment-modal">
        <div class="adjustment-modal-header">
            <h3>üí∞ Payroll Adjustments - <span id="modalEmployeeName"></span></h3>
            <button class="modal-close-btn" onclick="closeAdjustmentModal()">√ó</button>
        </div>
        <div class="adjustment-modal-body">
            <!-- Existing Adjustments -->
            <div class="existing-adjustments">
                <h4>Current Adjustments for {{ month_name }} {{ selected_year }}</h4>
                <div id="adjustmentsList">
                    <div class="no-adjustments">Loading...</div>
                </div>
            </div>

            <!-- Add New Adjustment -->
            <div class="add-adjustment-form">
                <h4>Add New Adjustment</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="adjustmentType">
                            <option value="incentive">Incentive (+)</option>
                            <option value="reduction">Reduction (-)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount (AED)</label>
                        <input type="number" id="adjustmentAmount" step="0.01" min="0" placeholder="0.00">
                    </div>
                </div>
                <div class="form-group">
                    <label>Reason</label>
                    <textarea id="adjustmentReason"
                        placeholder="e.g., Performance bonus, Advance recovery..."></textarea>
                </div>
                <div class="modal-actions">
                    <button class="btn-cancel" onclick="closeAdjustmentModal()">Cancel</button>
                    <button class="btn-save" onclick="saveAdjustment()">Add Adjustment</button>
                </div>
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="currentEmployeeId" value="">
<input type="hidden" id="selectedYear" value="{{ selected_year }}">
<input type="hidden" id="selectedMonth" value="{{ selected_month }}">
{% endblock %}

{% block extra_js %}
<script>
    let currentEmployeeId = null;

    function openAdjustmentModal(employeeId, employeeName) {
        currentEmployeeId = employeeId;
        document.getElementById('currentEmployeeId').value = employeeId;
        document.getElementById('modalEmployeeName').textContent = employeeName;
        document.getElementById('adjustmentModal').classList.add('show');
        loadAdjustments(employeeId);
    }

    function closeAdjustmentModal() {
        document.getElementById('adjustmentModal').classList.remove('show');
        document.getElementById('adjustmentType').value = 'incentive';
        document.getElementById('adjustmentAmount').value = '';
        document.getElementById('adjustmentReason').value = '';
    }

    function getCookie(name) {
        let value = "; " + document.cookie;
        let parts = value.split("; " + name + "=");
        if (parts.length == 2) return parts.pop().split(";").shift();
    }

    async function loadAdjustments(employeeId) {
        const year = document.getElementById('selectedYear').value;
        const month = document.getElementById('selectedMonth').value;
        const listEl = document.getElementById('adjustmentsList');

        try {
            const response = await fetch(`/payroll/api/adjustments/${employeeId}/?year=${year}&month=${month}`);
            const data = await response.json();

            if (data.success && data.adjustments.length > 0) {
                listEl.innerHTML = data.adjustments.map(adj => `
                    <div class="adjustment-item">
                        <div class="adjustment-info">
                            <span class="adjustment-type-badge ${adj.type}">${adj.type}</span>
                            <strong>AED ${adj.amount.toFixed(2)}</strong>
                            <div class="adjustment-reason">${adj.reason}</div>
                        </div>
                        <button class="delete-adjustment-btn" onclick="deleteAdjustment(${adj.id})">üóëÔ∏è Delete</button>
                    </div>
                `).join('');
            } else {
                listEl.innerHTML = '<div class="no-adjustments">No adjustments yet for this month</div>';
            }
        } catch (err) {
            listEl.innerHTML = '<div class="no-adjustments">Error loading adjustments</div>';
        }
    }

    async function saveAdjustment() {
        const employeeId = currentEmployeeId;
        const year = parseInt(document.getElementById('selectedYear').value);
        const month = parseInt(document.getElementById('selectedMonth').value);
        const type = document.getElementById('adjustmentType').value;
        const amount = parseFloat(document.getElementById('adjustmentAmount').value);
        const reason = document.getElementById('adjustmentReason').value.trim();

        if (!amount || amount <= 0) {
            alert('Please enter a valid amount');
            return;
        }

        if (!reason) {
            alert('Please enter a reason for the adjustment');
            return;
        }

        try {
            const response = await fetch('/payroll/api/adjustments/add/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    employee_id: employeeId,
                    year: year,
                    month: month,
                    type: type,
                    amount: amount,
                    reason: reason
                })
            });

            const data = await response.json();

            if (data.success) {
                document.getElementById('adjustmentAmount').value = '';
                document.getElementById('adjustmentReason').value = '';
                loadAdjustments(employeeId);
                // Reload page to update totals
                setTimeout(() => location.reload(), 500);
            } else {
                alert('Error: ' + data.error);
            }
        } catch (err) {
            alert('Error saving adjustment');
        }
    }

    async function deleteAdjustment(adjustmentId) {
        if (!confirm('Delete this adjustment?')) return;

        try {
            const response = await fetch(`/payroll/api/adjustments/delete/${adjustmentId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const data = await response.json();

            if (data.success) {
                loadAdjustments(currentEmployeeId);
                setTimeout(() => location.reload(), 500);
            } else {
                alert('Error: ' + data.error);
            }
        } catch (err) {
            alert('Error deleting adjustment');
        }
    }

    // Close modal on outside click
    document.getElementById('adjustmentModal').addEventListener('click', function (e) {
        if (e.target === this) {
            closeAdjustmentModal();
        }
    });
</script>
{% endblock %}